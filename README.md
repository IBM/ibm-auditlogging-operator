# IBM Audit Logging Operator

The IBM Audit Logging Operator contains a Fluentd solution to forward audit data generated by IBM Cloud Platform services to a configured SIEM. The operator deploys a Fluentd daemonset containing a systemd input plugin, remote_syslog output plugin, and fluent-plugin-splunk-hec output plugin. It also deploys the Audit Policy Controller.

## Supported platforms

Red Hat OpenShift Container Platform 4.X

## Operator versions

3.5.0

## Prerequisites

- Kubernetes 1.11.0 or higher
- Tiller 2.7.2 or higher
- ibm-certmanager-operator must be installed
- Must run in the `ibm-common-services` namespace

## Red Hat OpenShift SCC Requirements

The predefined SecurityContextConstraints (SCC) `privileged` and `anyuid` have been verified for this operator's operands, Fluentd and the Audit Policy Controller.

## Documentation

For installation and configuration, see [IBM Knowledge Center link].

## Developer guide

### Overview

- Read [Operator Guidelines](https://github.ibm.com/IBMPrivateCloud/roadmap/blob/master/feature-specs/common-services/operator-guideline/operator-guideline-spec.md)
  to learn about the guidelines for Common Services operator.

- An operator can manage one or more controllers. The controller watches the resources for a particular CR (Custom Resource).

- All of the resources that used to be created via a helm chart will be created via a controller.

- Determine how many CRDs (Custom Resource Definition) are needed. auditlogging will have 2 CRDs:
  - AuditLogging
  - AuditPolicy (generated by audit-policy-controller repo)

### Development

- These steps are based on [Operator Framework: Getting Started](https://github.com/operator-framework/getting-started#getting-started)
  and [Creating an App Operator](https://github.com/operator-framework/operator-sdk#create-and-deploy-an-app-operator).

- Repositories
  - <https://github.com/IBM/ibm-auditlogging-operator>
  - <https://github.ibm.com/IBMPrivateCloud/audit-logging-operator> - **the code in this repo has been deprecated**

- Set the Go environment variables.

  `export GOPATH=/home/<username>/go`
  `export GO111MODULE=on`
  `export GOPRIVATE="github.ibm.com"`

- Create the operator skeleton.
  - `cd /home/ibmadmin/workspace/cs-operators`
  - `operator-sdk new auditlogging-operator --repo github.com/ibm/ibm-auditlogging-operator`
  - the main program for the operator, `cmd/manager/main.go`, initializes and runs the Manager
  - the Manager will automatically register the scheme for all custom resources defined under `pkg/apis/...`
    and run all controllers under `pkg/controller/...`
  - the Manager can restrict the namespace that all controllers will watch for resources

- Create the API definition ("Kind") which is used to create the CRD
  - `cd /home/ibmadmin/workspace/cs-operators/auditlogging-operator`
  - create `hack/boilerplate.go.txt`
  - contains copyright for generated code
  - `operator-sdk add api --api-version=operator.ibm.com/v1alpha1 --kind=auditlogging`
  - generates `pkg/apis/operator/v1alpha1/auditlogging_types.go`
  - generates `deploy/crds/operator.ibm.com_auditloggings_crd.yaml`
  - generates `deploy/crds/operator.ibm.com_v1alpha1_auditlogging_cr.yaml`
  - the operator can manage more than 1 Kind

- Edit `<kind>_types.go` and add the fields that will be exposed to the user. Then regenerate the CRD.
  - edit `<kind>_types.go` and add fields to the `<Kind>Spec` struct
  - `operator-sdk generate k8s`
  - updates `zz_generated.deepcopy.go`
- "Operator Framework: Getting Started" says to run `operator-sdk generate openapi`. That command is deprecated, so run the next 2 commands instead.
  - `operator-sdk generate crds`
  - updates `operator.ibm.com_auditloggings_crd.yaml`
  - `openapi-gen --logtostderr=true -o "" -i ./pkg/apis/operator/v1alpha1 -O zz_generated.openapi -p ./pkg/apis/operator/v1alpha1 -h hack/boilerplate.go.txt -r "-"`
  - creates `zz_generated.openapi.go`
  - if you need to build `openapi-gen`, follow these steps. The binary will be built in `$GOPATH/bin`.

  ```bash
  git clone https://github.com/kubernetes/kube-openapi.git
  cd kube-openapi
  go mod tidy
  go build -o ./bin/openapi-gen k8s.io/kube-openapi/cmd/openapi-gen
  ```

  - **IMPORTANT**: Anytime you modify `<kind>_types.go`, run `generate k8s`, `generate crds`, and `openapi-gen` again to update the CRD and the generated code

- Create the controller. It will create resources like Deployments, DaemonSets, etc.
  - `operator-sdk add controller --api-version=operator.ibm.com/v1alpha1 --kind=auditlogging`
  - there is 1 controller for each Kind/CRD
  - the controller will watch and reconcile the resources owned by the CR
  - for information about the Go types that implement Deployments, DaemonSets, etc, go to <https://godoc.org/k8s.io/api/apps/v1>
  - for information about the Go types that implement Pods, VolumeMounts, etc, go to <https://godoc.org/k8s.io/api/core/v1>
  - for information about the Go types that implement Ingress, etc, go to <https://godoc.org/k8s.io/api/networking/v1beta1>

### Testing

#### Prerequisites for building the operator locally

- [Install linters](https://github.com/IBM/go-repo-template/blob/master/docs/development.md)

#### Run the operator on a cluster

- `make install`
- Run tests on cluster
- `make uninstall`

#### Run the operator locally

- `cd /home/ibmadmin/workspace/cs-operators/auditlogging-operator`
- `oc login...`
- `export OPERATOR_NAME=auditlogging-operator`
- `operator-sdk up local --namespace=<namespace>`

- Create a CR which is an instance of the CRD
  - edit `deploy/crds/operator.ibm.com_v1alpha1_auditlogging_cr.yaml`
  - `kubectl create -f deploy/crds/operator.ibm.com_v1alpha1_auditlogging_cr.yaml`

- Delete the CR and the associated resources that were created
  - `kubectl delete auditloggings example-auditlogging`

## Licensing

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at

<http://www.apache.org/licenses/LICENSE-2.0>

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
